# 2025-01-15 Memory Storage Recursion Fix

## Issue Analysis

After investigating the token overflow issue in the console, we identified a recursion problem in our memory storage system:

1. Storage Call Chain:
```
store_experience -> store_memory -> store_experience -> ...
```

2. Multiple Entry Points:
- thread_manager.py: _store_thread and _update_existing_thread
- agent_store.py: store_agent
- base.py: BaseAgent.store_memory
- environment.py: Multiple store_experience calls

3. Celery Task Complications:
- No explicit retry limits
- Potential for task chains to trigger recursion
- Multiple storage operations in single tasks

## Implemented Solutions

1. Direct Storage Pattern:
- Modified all components to use episodic.store_memory() directly instead of store_experience():
  * thread_manager.py: _store_thread and _update_existing_thread methods
  * agent_store.py: store_agent method
  * base.py: BaseAgent.store_memory method
  * environment.py: execute_action, pause_tasks, resume_tasks, and cleanup methods

2. Celery Task Protection:
```python
# Added explicit retry limits
celery_app.conf.update(
    task_default_retry_delay=5,  # 5 seconds between retries
    task_max_retries=3,  # Maximum of 3 retries
)

# Added recursion prevention flag
_storing_experience = False

# Example usage in tasks
if not _storing_experience:
    try:
        _storing_experience = True
        run_async(thread_manager.update_thread(thread))
    finally:
        _storing_experience = False
```

3. Verified No Signal Recursion:
- Checked for any Celery signals that could trigger recursive store_experience calls
- Confirmed no signal handlers causing recursion

## Storage Flow Before Fix

```
Celery Task
  └─> store_experience
       └─> store_memory
            └─> store_experience (recursion starts)
                 └─> store_memory
                      └─> store_experience
                           └─> ...
```

## Storage Flow After Fix

```
Celery Task (with retry limits & recursion flag)
  └─> episodic.store_memory (direct storage)
       └─> vector store operation
            └─> done
```

## Next Steps

1. Testing:
- Run thread storage tests to verify recursion is fixed
- Monitor console for token overflow
- Verify memory storage integrity
- Test concurrent operations

2. Monitoring:
- Watch for any retry attempts in Celery tasks
- Monitor memory usage during storage operations
- Check for any performance impacts

3. Documentation:
- Update storage pattern documentation
- Document new Celery task configurations
- Add notes about recursion prevention
