# 2025-01-18 Frontend-Backend Schema Discrepancies

## Schema Mismatches Found

### 1. Thread Schema
```typescript
// Frontend (frontend/src/lib/types/thread.ts)
interface Thread {
  id: string;
  title: string;
  status: 'active' | 'archived' | 'deleted';
  participants: Array<{
    id: string;
    type: 'user' | 'agent';
    joined_at: string;
  }>;
}

# Backend (src/nia/nova/core/models.py)
class Thread(BaseModel):
    id: str
    title: str
    status: ThreadStatus  # Enum with more states
    participants: List[Participant]  # Missing joined_at
```

Issues:
- Status enum mismatch (backend has more states)
- Participant schema differences
- Timestamp handling inconsistency

### 2. Message Schema
```typescript
// Frontend (frontend/src/lib/types/websocket-messages.ts)
interface ChatMessage {
    type: 'message';
    content: string;
    thread_id: string;
    sender_type: string;
    sender_id: string;
}

# Backend (src/nia/nova/core/models.py)
class Message(BaseModel):
    id: str  # Missing in frontend
    content: str
    thread_id: str
    sender: MessageSender  # Different structure
    timestamp: datetime  # Missing in frontend
    metadata: Optional[Dict]  # Missing in frontend
```

Issues:
- ID field missing in frontend
- Sender structure mismatch
- Missing timestamp in frontend
- Missing metadata in frontend

### 3. Task Schema
```typescript
// Frontend (frontend/src/lib/types/task.ts)
interface Task {
    id: string;
    title: string;
    status: TaskState;
    assignee?: string;
}

# Backend (src/nia/nova/core/models.py)
class Task(BaseModel):
    id: str
    title: str
    status: TaskStatus
    assignees: List[str]  # Multiple assignees possible
    priority: TaskPriority  # Missing in frontend
    due_date: Optional[datetime]  # Missing in frontend
```

Issues:
- Single vs multiple assignees
- Missing priority field in frontend
- Missing due date in frontend
- Status enum values might differ

### 4. Agent Schema
```typescript
// Frontend (frontend/src/lib/types/agent.ts)
interface Agent {
    id: string;
    name: string;
    type: string;
    status: string;
}

# Backend (src/nia/nova/core/models.py)
class Agent(BaseModel):
    id: str
    name: str
    agent_type: AgentType  # Enum vs string
    status: AgentStatus  # Enum vs string
    capabilities: List[str]  # Missing in frontend
    metadata: Dict  # Missing in frontend
```

Issues:
- Type handling (string vs enum)
- Status handling (string vs enum)
- Missing capabilities in frontend
- Missing metadata in frontend

## Required Updates

### 1. Frontend Updates Needed
1. Thread Types:
   ```typescript
   // Update status enum
   type ThreadStatus = 'active' | 'archived' | 'deleted' | 'paused' | 'processing';
   
   // Update participant
   interface Participant {
     id: string;
     type: 'user' | 'agent';
     joined_at: string;
     role?: string;  // Add optional role
   }
   ```

2. Message Types:
   ```typescript
   interface ChatMessage {
     id: string;  // Add ID
     type: 'message';
     content: string;
     thread_id: string;
     sender_type: string;
     sender_id: string;
     timestamp: string;  // Add timestamp
     metadata?: Record<string, unknown>;  // Add metadata
   }
   ```

3. Task Types:
   ```typescript
   interface Task {
     id: string;
     title: string;
     status: TaskState;
     assignees: string[];  // Change to array
     priority: TaskPriority;  // Add priority
     due_date?: string;  // Add due date
   }
   ```

4. Agent Types:
   ```typescript
   interface Agent {
     id: string;
     name: string;
     type: AgentType;  // Use enum
     status: AgentStatus;  // Use enum
     capabilities: string[];  // Add capabilities
     metadata?: Record<string, unknown>;  // Add metadata
   }
   ```

### 2. Backend Updates Needed
1. Thread Model:
   ```python
   class Thread(BaseModel):
       id: str
       title: str
       status: ThreadStatus
       participants: List[Participant]
       created_at: datetime  # Add creation time
       updated_at: datetime  # Add update time
   ```

2. Message Model:
   ```python
   class Message(BaseModel):
       id: str
       content: str
       thread_id: str
       sender: MessageSender
       timestamp: datetime
       metadata: Optional[Dict] = {}  # Make metadata optional
   ```

3. Task Model:
   ```python
   class Task(BaseModel):
       id: str
       title: str
       status: TaskStatus
       assignees: List[str]
       priority: TaskPriority
       due_date: Optional[datetime] = None  # Make due date optional
       created_at: datetime  # Add creation time
   ```

4. Agent Model:
   ```python
   class Agent(BaseModel):
       id: str
       name: str
       agent_type: AgentType
       status: AgentStatus
       capabilities: List[str] = []  # Make capabilities optional
       metadata: Dict = {}  # Make metadata optional
   ```

## Implementation Plan

1. Schema Updates:
   - Update frontend type definitions
   - Update backend models
   - Add validation schemas
   - Update serialization/deserialization

2. API Updates:
   - Update endpoint request/response handling
   - Add schema version headers
   - Add validation middleware
   - Update error responses

3. Migration:
   - Create database migration scripts
   - Add data transformation layer
   - Update existing records
   - Add schema version tracking

4. Testing:
   - Add schema validation tests
   - Update API tests
   - Add migration tests
   - Update integration tests

## Next Steps

1. Create schema update PR
2. Update API documentation
3. Create migration scripts
4. Update test suite
5. Plan deployment strategy
